<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Paper Doll Designer</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="description" content="">
	<meta name="author" content="">

	<link href="css/bootstrap.min.css" rel="stylesheet">
	<link href="css/style.css" rel="stylesheet">

	<!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
	<!--[if lt IE 9]>
	<script src="js/html5shiv.js"></script>
	<![endif]-->

	<!-- Fav and touch icons -->
	<link rel="apple-touch-icon-precomposed" sizes="144x144" href="img/apple-touch-icon-144-precomposed.png">
	<link rel="apple-touch-icon-precomposed" sizes="114x114" href="img/apple-touch-icon-114-precomposed.png">
	<link rel="apple-touch-icon-precomposed" sizes="72x72" href="img/apple-touch-icon-72-precomposed.png">
	<link rel="apple-touch-icon-precomposed" href="img/apple-touch-icon-57-precomposed.png">
	<link rel="shortcut icon" href="img/favicon.png">

	<script type="text/javascript" src="js/jquery.min.js"></script>
	<script type="text/javascript" src="js/bootstrap.min.js"></script>
	<script type="text/javascript" src="js/scripts.js"></script>

	<!-- Load the Paper.js library -->
	<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/paper.js/0.9.18/paper-full.min.js"></script>

	<!--<script type="text/javascript" src="scripts.js"></script>-->
	<script type="text/javascript" src="http://teaching-materials.org/ajax/lib/jquery.min.js"></script>
	<script src="blockly/blockly_compressed.js"></script>
	<script src="blockly/javascript_compressed.js"></script>
	<script src="blockly/blocks_compressed.js"></script>
	<script src="blockly/msg/js/en.js"></script>

	<script src="blockly/blocks/patternmaker.js"></script>
	<script src="blockly/generators/javascript/patternmaker.js"></script>


	<style type="text/css">
		body {
			background-color: #CACCCC;
		}
	</style>
</head>

<body>

<div class="container">
	<div class="row clearfix">
		<div class="col-md-12 column">
			<h1>
				Paper Doll Designer
			</h1>
			<dl>
				<dd>
					Choose clothes and accessories and decorate them with code!
				</dd>
			</dl>
		</div>
	</div>
	<div class="row clearfix">
		<div class="col-md-2 column">
			<button type="button" class="btn btn-default" onclick="printCode()">Print code</button>
			<button type="button" class="btn btn-default" onclick="runCode()">Run code</button>
			<button type="button" class="btn btn-default" onclick="colorChange()">Randomize color</button>
			<button type="button" class="btn btn-default" onclick="paperscript.addStripe(0)">Add stripe</button>
			<button type="button" class="btn btn-default" onclick="downloadSVG()">Download</button>
		</div>
		<div class="col-md-3 column">
			<canvas id="dollCanvas" width="340" height="550"></canvas>
		</div>
		<div class="col-md-1 column">
		</div>
		<div class="col-md-6 column">

			<xml id="toolbox" style="display: none">
				<category name="Drawing">
					<block type="patternmaker_clear"></block>
					<block type="patternmaker_stripe"></block>
					<block type="patternmaker_pen_color"></block>
					<block type="patternmaker_pen_size">
						<value name="PEN_SIZE">
							<block type="math_number">
								<field name="NUM">6</field>
							</block>
						</value>
					</block>
					<block type="patternmaker_move_up">
						<value name="MOVE_UP">
							<block type="math_number">
								<field name="NUM">10</field>
							</block>
						</value>
					</block>
					<block type="patternmaker_move_right">
						<value name="MOVE_RIGHT">
							<block type="math_number">
								<field name="NUM">10</field>
							</block>
						</value>
					</block>
					<block type="patternmaker_setx">
						<value name="X">
							<block type="math_number">
								<field name="NUM">0</field>
							</block>
						</value>
					</block>
					<block type="patternmaker_sety">
						<value name="Y">
							<block type="math_number">
								<field name="NUM">0</field>
							</block>
						</value>
					</block>
					<block type="patternmaker_draw_shape">
						<value name="WIDTH">
							<block type="math_number">
								<field name="NUM">6</field>
							</block>
						</value>
						<value name="HEIGHT">
							<block type="math_number">
								<field name="NUM">6</field>
							</block>
						</value>
					</block>
				</category>
				<category name="Control">
					<block type="patternmaker_start"></block>
					<block type="controls_repeat"></block>


				</category>
				<category name="Math">
					<block type="logic_compare"></block>
					<block type="math_number"></block>
					<block type="math_arithmetic"></block>
				</category>
				<sep></sep>
				<category name="Variables" custom="VARIABLE"></category>
				<category name="Functions" custom="PROCEDURE"></category>
			</xml>
			<div id="blocklyDiv" style="height: 540px; width: 700px;"></div>
		</div>
	</div>
	<div class="row clearfix">
		<div class="col-md-12 column">
			<div id="textarea"></div>
		</div>
	</div>
</div>

<script>
	Blockly.HSV_SATURATION = 1.0;
	Blockly.HSV_VALUE = 0.8;

	Blockly.inject(document.getElementById('blocklyDiv'),
			{toolbox: document.getElementById('toolbox')});

	function blocksToJavascript() {
		var code = Blockly.JavaScript.workspaceToCode();
		$("#textarea").html(code);
	}
	Blockly.addChangeListener(blocksToJavascript);

//	Blockly.Blocks.colour.HUE = 10;
//	Blockly.Blocks.lists.HUE = 10;
	Blockly.Blocks.logic.HUE = 93;
	Blockly.Blocks.loops.HUE = 43;
	Blockly.Blocks.math.HUE = 93;
	Blockly.Blocks.procedures.HUE = 270;
	Blockly.Blocks.variables.HUE = 29;
</script>

<script>
	var paperscript = {}; //hold functions and variables defined inside the paperscript code

	var xPos = 30;
	var yPos = 110;
	var penColor = '#FFFFFF';
	var penSize = 4;
	var w = 300;
	var h = 510;

	function printCode() {
		console.log(Blockly.JavaScript.workspaceToCode());
	}

	function runCode() {
		Blockly.JavaScript.addReservedWords('code');
		var code = Blockly.JavaScript.workspaceToCode();
		try {
			eval(code);
		} catch (e) {
			alert(e);
		}
	}

	function addStripe(angle)
	{
		paperscript.addStripe(angle);
	}

	function setPenSize(size) {
		penSize = size;
	}

	function setPenColor(color) {
		penColor = color;
	}

	function colorChange() {
		var red = Math.round(Math.random() * 255);
		var green = Math.round(Math.random() * 255);
		var blue = Math.round(Math.random() * 255);
		activeOutfit.set('fill', 'rgba(' + red + ',' + green + ',' + blue + ',1)');
		console.log("changed color to " + red + "," + green + "," + blue);
		canvas.renderAll();
	}

	function moveUp(spaces) {
		paperscript.moveUp(spaces);
	}

	function moveRight(spaces) {
		paperscript.moveRight(spaces);
	}

	function downloadDataUri(options) {
		if (!options.url)
			options.url = "http://download-data-uri.appspot.com/";
		$('<form method="post" action="' + options.url
		+ '" style="display:none"><input type="hidden" name="filename" value="'
		+ options.filename + '"/><input type="hidden" name="data" value="'
		+ options.data + '"/></form>').appendTo('body').submit().remove();
	}

	//	$('#export-button').click(function() {
	function downloadSVG() {
		var svg = paperscript.project.exportSVG({asString: true});
		downloadDataUri({
			data: 'data:image/svg+xml;base64,' + btoa(svg),
			filename: 'export.svg'
		});
	};


</script>



<script type="text/paperscript" canvas="dollCanvas">

	var outfit;
	var patternGroup;
	var cursor;
	var cursorX;
	var cursorY;
	var rulerWidth = 40;

	var numMarkings = 150; //cm
	var markingWidth = h / 150;

	console.log(markingWidth);

	function toPaperCoords(pos) {
		return pos * markingWidth;
	}

	var backgroundRect = new Rectangle(new Point(rulerWidth, 0), new Point(w+rulerWidth, h+rulerWidth));
	var background = new Path.Rectangle(backgroundRect);
	background.fillColor = '#ffffff';

	//vertical ruler
	var rulerRectY = new Rectangle(new Point(0, 0), new Point(rulerWidth, h));
	var rulerY = new Path.Rectangle(rulerRectY);
	rulerY.fillColor = '#F7E048';

	//horizontal ruler
	var rulerRectX = new Rectangle(new Point(rulerWidth, h), new Point(w+rulerWidth, h+rulerWidth));
	var rulerX = new Path.Rectangle(rulerRectX);
	rulerX.fillColor = '#F7E048';

	//markings on vertical ruler
	var label = numMarkings;
	for(var i=0;i<h-markingWidth;i+=markingWidth*10)
	{
		var marking = new Path.Line(new Point(rulerWidth/2, i), new Point(rulerWidth, i));
		marking.strokeColor = 'black';
		if(i > 0) {
			var text = new PointText(new Point(rulerWidth/4, i+4));
			text.justification = 'center';
			text.fillColor = 'black';
			text.content = label;
		}
		for(var j=0;j<10;j++)
		{
			var smallMarking = new Path.Line(new Point(2*rulerWidth/3, i+j*markingWidth), new Point(rulerWidth, i+j*markingWidth));
			smallMarking.strokeColor = 'black';
		}
		label -= 10;
	}
	var marking = new Path.Line(new Point(rulerWidth/2, h), new Point(rulerWidth, h));
	marking.strokeColor = 'black';
	var text = new PointText(new Point(rulerWidth/4, h+4));
	text.justification = 'center';
	text.fillColor = 'black';
	text.content = 0;

	//markings on horizontal ruler
	label = 0;
	for(var i=rulerWidth;i<w+rulerWidth-markingWidth;i+=markingWidth*10)
	{
		var marking = new Path.Line(new Point(i, h), new Point(i, h+rulerWidth/2));
		marking.strokeColor = 'black';
		var text = new PointText(new Point(i, h+3*rulerWidth/4));
		text.justification = 'center';
		text.fillColor = 'black';
		text.content = label;
		for(var j=0;j<10;j++)
		{
			var smallMarking = new Path.Line(new Point(i+j*markingWidth, h), new Point(i+j*markingWidth, h+rulerWidth/3));
			smallMarking.strokeColor = 'black';
		}
		label+=10;
	}
	//var marking = new Path.Line(new Point(w+rulerWidth, h), new Point(w+rulerWidth, h+rulerWidth/2));
	//marking.strokeColor = 'black';

	project.importSVG('assets/doll.svg', {
        expandShapes: true,
        onLoad: function(item) {
        	item.position.x = view.center.x+rulerWidth/2;
            console.log("doll loaded");

            project.importSVG('assets/hair in bun.svg', {
       		 	expandShapes: true,
        		onLoad: function(item) {
    			item.position.x = view.center.x+rulerWidth/2+1;
    			project.importSVG('assets/no sleeve dress.svg', {
		expandShapes: true,
		onLoad: function(item) {
			outfit = item;
			outfit.position.x = view.center.x+rulerWidth/2;
			patternGroup = new Group(outfit.clone());
			patternGroup.clipped = true;

			var star = new Path.Star({
				center: view.center,
				points: 6,
				radius1: 20,
				radius2: 40,
				fillColor: 'red'
			});
			patternGroup.addChild(star);

			//set up cursors to show current x, y position

			cursor = new Point(rulerWidth+toPaperCoords(xPos), h-toPaperCoords(yPos));

			//horizontal
			cursorY = new Path.Line(new Point(rulerWidth, h-toPaperCoords(yPos)), cursor);
			//cursorY = new Path.Line(new Point(rulerWidth, h-toPaperCoords(yPos)), new Point(rulerWidth+toPaperCoords(xPos), h-toPaperCoords(yPos)));
			cursorY.strokeColor = '#7C7C7D';
			cursorY.dashArray = [6, 4];

			//vertical
			cursorX = new Path.Line(new Point(rulerWidth+toPaperCoords(xPos), h), cursor);
			//cursorX = new Path.Line(new Point(rulerWidth+toPaperCoords(xPos), toPaperCoords(h)), new Point(rulerWidth+toPaperCoords(xPos), h-toPaperCoords(yPos)));
			cursorX.strokeColor = '#7C7C7D';
			cursorX.dashArray = [6, 4];
		}
	});
			}
    		});
        }
    });

	this.addStripe = function addStripe(angle) {

		// Create a Paper.js Path to draw a line into it:
		var path = new paper.Path();
		// Give the stroke a color
		path.strokeColor = penColor;
		path.strokeWidth = toPaperCoords(penSize);
		var start = new paper.Point(0, yPos);
		// Move to start and draw a line from there
		path.moveTo(start);

		path.lineTo(start.add([300, 0]));

		patternGroup.addChild(path);

		// Draw the view now:
		paper.view.draw();
	}

	this.updateCursors = function updateCursors()
	{
		cursor.x = rulerWidth + toPaperCoords(xPos);
		cursor.y = h - toPaperCoords(yPos);

		//cursorY.replaceWith(new Path.Line(new Point(rulerWidth, h-toPaperCoords(yPos)), cursor));
		//cursorX.replaceWith(new Path.Line(new Point(rulerWidth+toPaperCoords(xPos), h), cursor));

		paper.view.draw();
	}

	this.moveUp = function moveUp(spaces) {
		yPos -= spaces; //different coordinate systems
		console.log('yPos: ' + yPos);
		cursorY.position.y -= spaces;
		cursorX.position.y -= spaces;
		paper.view.draw();
	}

	this.moveRight = function moveRight(spaces) {
		xPos += spaces; //different coordinate systems
		console.log('xPos: ' + yPos);
		cursorX.position.x += spaces;
		cursorY.position.x += spaces;
		paper.view.draw();
	}





	paper.install(window.paperscript);


</script>

</body>
</html>